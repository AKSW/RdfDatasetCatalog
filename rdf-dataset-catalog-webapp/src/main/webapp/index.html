<!DOCTYPE html>
<html ng-app="RdfDatasetCatalog">

<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">

    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <title>RDF Dataset Catalog</title>
	
    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <!-- build:css(.tmp) styles/main.css -->

    <!-- bower:css -->
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.css" />
    <link rel="stylesheet" href="bower_components/jassa-ui-angular/jassa-ui-angular.css" />
    <link rel="stylesheet" href="bower_components/jassa-ui-angular-openlayers/jassa-ui-angular-openlayers.css" />
    <!-- endbower -->

	<link rel="stylesheet" href="bower_components/ng-grid-bower/ng-grid.css" />

    <link rel="stylesheet" href="styles/rdf-dataset-catalog-style.css" />

    <style>
    .login-labels: {
        width: 300px;
    }
    
    .login-fields: {
        width: 200px;
    }
/* 	.bs-sidebar.affix { */
/* 	  width: 263px; */
/* 	  top: 25px; */
/* 	} */
		
/* 	@media (min-width: 768px) { */
/* 	  .bs-sidebar.affix { */
/* 	    width: 158px; */
/* 	    top: 25px; */
/* 	  } */
/* 	} */
	
/* 	@media (min-width: 992px) { */
/* 	  .bs-sidebar.affix { */
/* 	    width: 213px; */
/* 	    position: fixed; */
/* 	    top: 25px; */
/* 	  } */
/* 	} */
	
/* 	@media (min-width: 1200px) { */
/* 	  .bs-sidebar.affix { */
/* 	    width: 263px; */
/* 	  } */
/* 	}     */
    </style>

    <!-- endbuild -->

	
    <!-- build:js scripts/scripts.js -->

    <script src="bower_components/jscache/cache.js"></script>

    <!-- bower:js -->
    <script src="bower_components/jquery/jquery.js"></script>
    <script src="bower_components/underscore/underscore.js"></script>
    <script src="bower_components/jassa/jassa.js"></script>
    <script src="bower_components/angular/angular.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.js"></script>
    <script src="bower_components/ng-grid-bower/ng-grid.js"></script>
    <script src="bower_components/angular-sanitize/angular-sanitize.js"></script>
    <script src="bower_components/jassa-ui-angular/jassa-ui-angular-tpls.js"></script>
    <script src="bower_components/jquery-ui/ui/jquery-ui.js"></script>
    <script src="bower_components/jassa-ui-angular-openlayers/jassa-ui-angular-openlayers-tpls.js"></script>
    <script src="bower_components/angular-ui-router/release/angular-ui-router.js"></script>
    <!-- endbower -->



	<script src="scripts/lib/ng-grid-flexible-height/ng-grid-flexible-height.js"></script>

    <script src="scripts/lib/angular-ui/0.10.0/ui-bootstrap-tpls-0.10.0.js"></script>
    <script src="bower_components/underscore.string/lib/underscore.string.js"></script>
    <script src="bower_components/openlayers/lib/OpenLayers.js"></script>

    <!-- endbuild -->

<!--    <script src="js/jassa-ui-angular-geo-openlayers-tpls.js"></script> -->
	
	<script type="text/javascript">
    _.mixin(_.str.exports());

	var rdf = Jassa.rdf;
	var sparql = Jassa.sparql;
    var service = Jassa.service;
	var sponate = Jassa.sponate;
    var facete = Jassa.facete;
	var geo = Jassa.geo;
	var util = Jassa.util;
	
	var client = Jassa.client;

	
    var storeApiUrl = '/api/store';

	
	var applyScope = function($scope) {
	    if(!$scope.$$phase) {
	        $scope.$apply();
	    }
	};
	
    angular.module('RdfDatasetCatalog', ['ui.router', 'ui.bootstrap', 'ui.jassa', 'ngGrid', 'ui.jassa.openlayers', 'ngSanitize'])

    .config([function() {
        // Setup drop down menu
        jQuery('.dropdown-toggle').dropdown();
       
        // Fix input element click problem
        jQuery('.dropdown input, .dropdown label').click(function(e) {
          e.stopPropagation();
        });        
    }])
    
    .config(['$stateProvider', '$urlRouterProvider', function($stateProvider, $urlRouterProvider) {
        $urlRouterProvider.otherwise("/overview");

        //
        // Now set up the states
        $stateProvider

        .state('overview', {
            url: "/overview",
            templateUrl: "partials/overview.html",
            controller: function($scope) {

                var jassa = Jassa;                
                var sparqlService = new jassa.service.SparqlServiceHttp('/api/sparql', []);
                //sparqlService = new jassa.service.SparqlServiceCache(sparqlServiceCore);

        var prefixes = {
            'o': 'http://dcat.cc/ontology/',
            'r': 'http://dcat.cc/resource/',
            'rdf': 'http://www.w3.org/1999/02/22-rdf-syntax-ns#',
            'rdfs': 'http://www.w3.org/2000/01/rdf-schema#',
            'owl': 'http://www.w3.org/2002/07/owl#',
            'dcat': 'http://www.w3.org/ns/dcat#'
        };

        var labelMap = jassa.sponate.SponateUtils.createDefaultLabelMap();
        
        var store = new sponate.StoreFacade(sparqlService, prefixes);
        
        store.addMap(labelMap, 'labels');                
                
                $scope.search = {text: ''};
                
                $scope.$watch('search.text', function(val) {
                    $scope.refreshResults(val); 
                });
                
                
                $scope.requestId = 1;
                
                $scope.refreshResults = function(re) {
                    var requestId = ++$scope.requestId;

                    if(!re || re === '') {
                        $scope.items = [];
                        return;
                    }
                    
                    //var re = 'DB';
                    //var concept = 
                    var promise = store.labels.find({$or: [{id: {$regex: re}}, {hiddenLabels: {$elemMatch: {id: {$regex: re}}}}]}).asList(true);
                    
                    promise.done(function(data) {
                        if(requestId != $scope.requestId) {
                            return;
                        }
                        
                        $scope.items = data;
                        console.log(data);
                        applyScope($scope);
                    });
                    
                }
                
                $scope.refreshResults();
            }
        })
		.state('register-dataset', {
		    url: "/register-dataset",
		    templateUrl: "partials/edit-dataset.html"
		})
		.state('state1.list', {
		    url: "/list",
		    templateUrl: "partials/state1.list.html",
		    controller: function($scope) {
		        $scope.items = ["A", "List", "Of", "Items"];
		    }
		})
		.state('state2', {
		    url: "/state2",
		    templateUrl: "partials/state2.html"
		 })
		.state('state2.list', {
		    url: "/list",
		    templateUrl: "partials/state2.list.html",
		    controller: function($scope) {
		        $scope.things = ["A", "Set", "Of", "Things"];
		    }
		})
        .state('about', {
            url: "/about",
            templateUrl: "partials/about.html"
        })
    }])        
    
    .filter('reverse', function() {
		return function(items) {
			return items.slice().reverse();
		};
	})
    
	.directive('customAutofocus', function() {
        return {
            restrict: 'A',

            link: function(scope, element, attrs) {
                var expr = function() {
                    return scope.$eval(attrs.customAutofocus);
                };
 
                scope.$watch(expr, function(newValue) {
                    console.log('dammit');
                    if(newValue == true){
                        element[0].focus(); //use focus function instead of autofocus attribute to avoid cross browser problem. And autofocus should only be used to mark an element to be focused when page loads.
                    }
  	            });
	        }
	    };
	})
	
    .controller('AppCtrl', ['$scope', function($scope) {
        
        $scope.account = {};
        
        $scope.datasetForm = {};

        
        $scope.notifications = [];
        
        $scope.swapArrayItems = function(arr, i, j) {
            var tmp = arr[i];
            arr[i] = arr[j];
            arr[j] = tmp;
        };
        
        $scope.checkSession = function() {
            var spec = {
	            url: storeApiUrl + '/checkSession',
	            type: 'POST',
	            data: {},
	            traditional: true,
	            dataType: 'json'
            };

            jQuery.ajax(spec)
            .done(function(data) {
                $scope.account.username = data.username;
            })
            .fail(function() {
                alert('Failed to get session state');
            })
            .then(function() {
                applyScope($scope);
            });            
        };

        $scope.checkSession();
        
        $scope.logOut = function() {
            var spec = {
	            url: storeApiUrl + '/logOut',
	            type: 'POST',
            };

            jQuery.ajax(spec)
            .done(function() {
            })
            .fail(function() {
                alert('Failed to log out');
            })
            .then(function() {
                $scope.account.username = null;
                applyScope($scope);
            });
        };
        
        $scope.logIn = function(credentials) {
            var spec = {
	            url: storeApiUrl + '/logIn',
	            type: 'POST',
	            data: {
	                username: credentials.username,
	                password: credentials.password
	            },
	            traditional: true,
	            dataType: 'json'
            };

            jQuery.ajax(spec)
            .done(function(data) {
                $scope.account.username = data.username;
            })
            .fail(function() {
                alert('Fail');
            })
            .then(function() {
                applyScope($scope);
            });
                        
        };
        
        $scope.registerAndLogIn = function(credentials) {
            var spec = {
		        url: storeApiUrl + '/registerUser',
		        type: 'POST',
		        data: {
		            username: credentials.username,
		            password: credentials.password,
		            email: credentials.email
		        },
		        traditional: true,
		        dataType: 'json'
		    };
		    
		    jQuery.ajax(spec)
		    .done(function(data) {
                $scope.account.name = data.name;
                applyScope($scope);
		    })
		    .fail(function() {
		        alert('Fail');
		    })
		    .then(function() {
		        applyScope($scope);
		        
		        $scope.checkSession();
		    });
		    
        };
        
    }])
    
    .controller('EditDatasetCtrl', ['$scope', function($scope) {
        $scope.editMode = false;
        
        $scope.desc = {
            recordId: '',
            name: '',
            version: '',
            comment: '',
            recordLabel: '',
            recordComment: '',            
            sparqlEndpoints: [],
            downloadLocations: [],
            relations: [],
            containment: {
                isExact: true,
                items: []
            }
        };
        
        $scope.store = function(data) {

            
            //data.label = 'test';
            //data.comment = 'foobar';
            
            //data.downloadLocations = [ 'http://foo.org/bar', 'http://foo.org/baz' 
				//{uri: 'http://foo.org/bar'},
				//{uri: 'http://foo.org/baz'}
			//];
            
            var dataStr = JSON.stringify(data);
            //alert('Data: ' + dataStr);
                        
            
            
            var spec = {
                url: storeApiUrl + '/put',
                type: 'POST',
                data: {
                    data: dataStr,
                },
                traditional: true,
                dataType: 'json'
            };
            
            jQuery.ajax(spec)
            .done(function(data) {
                alert(dataStr);
            })
            .fail(function() {
                alert('Fail');
            })
            .then(function() {
                applyScope($scope);
            });
            
            
        }
    }])
    
    .controller('ArmDeleteCtrl', ['$scope', function($scope) {
        
        $scope.isDeleteArmed = false;
        
        $scope.remove = function(arr, index) {
            if($scope.isDeleteArmed) {
                arr.splice(index, 1);
            }
            else {
                $scope.isDeleteArmed = true;
                setTimeout(function() {
                    $scope.isDeleteArmed = false;
                    
                    applyScope($scope);
               }, 1500);
            }
            
        };
    }])
    
    ;
    
    </script>

</head>

<body ng-controller="AppCtrl">

	<nav class="navbar navbar-default" role="navigation">
		<div class="container-fluid">
			<!-- Brand and toggle get grouped for better mobile display -->
   			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				
				<a class="navbar-brand" style="padding: 3px 15px;" href="#"><img style="height: 42px; transform: rotate(180deg);" src="images/logo-datacat.png" alt=""></img></a>
				<a class="navbar-brand" href="#"><span style="color: #ab3479">RDF</span> <span style="color: #df752c">Data</span>set <span style="color: #7db442">Cat</span>alog</a>
			</div>

			<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
<!-- 				 <form class="navbar-form navbar-left" role="search"> -->
<!-- 	        		<div class="form-group"> -->
<!-- 	        			<div class="input-group"> -->
<!-- 		          			<input type="text" ng-model="app.searchString" class="form-control" placeholder="Find Dataset..."> -->
<!-- 		          			<span class="input-group-btn"> -->
<!-- 		        				<button type="submit" class="btn btn-default" ng-click="doSearch(app.searchString)">Submit</button> -->
<!-- 		          			</span> -->
<!-- 		          		</div>	          			 -->
<!-- 	        		</div> -->
<!-- 				</form> -->

                <ul class="nav nav-pills navbar-nav">
                    <li class="active"><a ui-sref="overview">Overview</a></li>
		            <li><a ui-sref="register-dataset">Register a Dataset</a></li>
		            <li><a ui-sref="state2">Browse</a></li>
                    <li><a ui-sref="state2">FAQ</a></li>
                    <li><a ui-sref="about">About</a></li>
                </ul>		

				<ul class="nav nav-pills navbar-nav navbar-right">
				    <li ng-show="account.username">
                        Hello, {{account.username}}! <a href="" ng-click="logOut()"><b>Logout</b></a>
				    </li>
					<li ng-show="!account.username" class="dropdown">
					    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Login <b class="caret"></b></a>
                        <div class="dropdown-menu" style="width: 300px; padding: 15px; padding-bottom: 0px;">
							<form action="">
							    <div class="form-group">
							        <div class="input-group">
<!-- 							            <span class="input-group-addon">Username</span> -->
							            <input ng-model="login.username" type="text" class="form-control" placeholder="Username" required>
							        </div>
                                </div>
                                <div class="form-group">
									<div class="input-group">
<!-- 									    <span class="input-group-addon">Password</span> -->
									    <input ng-model="login.password" type="text" class="form-control" placeholder="Password" required>
									</div>
							    </div>
                                <div class="form-group">
                                    <button ng-click="logIn(login)" type="submit" class="btn btn-primary" value="logIn" style="width: 100%">Log In</button>
                                </div>
							</form>
							<form action="">
								<div class="form-group">
								    <div class="input-group">
<!-- 								        <span class="input-group-addon">Confirm Password:</span> -->
								        <input ng-model="login.confirmPassword" type="text" class="form-control" placeholder="Confirm Password" required>
								    </div>
								                      </div>
								                      <div class="form-group">
								    <div class="input-group">
<!-- 								        <span class="input-group-addon">Email</span> -->
								        <input ng-model="login.email" type="text" class="form-control" placeholder="Email" required>
								    </div>
								 </div>
								 <div class="form-group">
								    <div class="input-group">
<!-- 								        <span class="input-group-addon">Email</span> -->
								        <input ng-model="login.confirmEmail" type="text" class="form-control" placeholder="Confirm Email" required>
								    </div>
								 </div>
								 <div class="form-group">
								        <button ng-click="registerAndLogIn(login)" type="submit" class="btn btn-primary" value="logIn" style="width: 100%">Register & Log In</button>
								 </div>                          
							</form>
                        </div>

                    </li>
				</ul>

			</div>

		</div>
	</nav>

<!--     <div class="container"> -->
<!--         <div class="row"> -->
<!--             <div class="col-sm-3"> -->
<!--                 <div class="well bs-sidebar affix">			 -->
<!-- 				    <ul class="nav nav-pills nav-stacked"> -->
<!-- 				        <li class="active"><a ui-sref="state1">State 1</a></li> -->
<!-- 				        <li><a ui-sref="state2">State 2</a></li> -->
<!-- 				        <li><a href="#">Messages</a></li> -->
<!-- 				    </ul> -->
<!-- 				</div> -->
<!-- 			</div> -->
<!-- 			<div class="col-sm-9"> -->
<!--                 <div class="container" ng-controller="EditDatasetCtrl">  -->
<!--                     <div ui-view></div> -->
<!--                 </div> -->
<!-- 			</div> -->
<!--         </div> -->
<!--     </div>		 -->

    <div class="container" ng-controller="EditDatasetCtrl"> 
        <div ui-view></div>
    </div>

</body>

</html>

